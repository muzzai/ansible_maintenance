---
- name: Gather data
  hosts: localhost
  gather_facts: false
  vars:
    aws_region: "{{ aws_region | default('') }}"
  tasks:
    - name: Fail if aws_region is not set
      when: aws_region == ''
      ansible.builtin.fail:
        msg: "AWS region is not set"

    - name: Gather EC2 instances info
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
      register: ec2_info

    - name: Build list of instances with internal IP and parsed Name
      ansible.builtin.set_fact:
        instances_with_445: >-
          {{
            instances_with_445 | default([]) + [
              {
                'id': item.instance_id,
                'name': instance_name,
                'name_suffix': name_suffix,
                'internal_ip': item.network_interfaces[0].private_ip_address
              }
            ]
          }}
      vars:
        instance_name: "{{ item.tags.Name | default('') }}"
        name_suffix: >-
          {{ instance_name | regex_replace('.*\(([^()]*)\)\s*$', '\1') if '(' in instance_name else '' }}
      loop: "{{ ec2_info.instances }}"
      when:
        - item.network_interfaces | length > 0
        - item.tags.Name is defined

    - name: Check if port 445 is open on each instance
      ansible.builtin.command: "nmap -Pn -p 445 {{ item.internal_ip }}"
      register: nmap_result
      loop: "{{ instances_with_445 }}"
      changed_when: false

    - name: Filter instances where port 445 is open
      ansible.builtin.set_fact:
        instances_with_445_open: >-
          {{
            instances_with_445 | zip(nmap_result.results) | selectattr('1.stdout', 'search', '445/tcp open') | map(attribute='0') | list
          }}

    - name: Show instances with port 445 open (confirmed by nmap)
      ansible.builtin.debug:
        var: instances_with_445_open

- name: Configure monitoring host
  hosts: monitoring_hosts
  gather_facts: false
  vars_files:
    - defaults/create_linux_ec2_instance_defaults.yml
  vars:
    instances_with_445_open: "{{ hostvars['localhost']['instances_with_445_open'] | default([]) }}"
  tasks:
    - name: Build connection details for monitoring hosts
      delegate_to: localhost
      block:
        - name: Include build_connection_details role
          ansible.builtin.include_role:
            name: build_connection_details

    # Check fluent-bit service status
    - name: Check if fluent-bit service is installed, enabled, and running
      ansible.builtin.systemd:
        name: fluent-bit
      register: fluent_bit_status
      failed_when: false
      become: true

    - name: Set fluent_bit_installed fact
      ansible.builtin.set_fact:
        fluent_bit_installed: >-
          {{ fluent_bit_status.status is defined and
              fluent_bit_status.status.LoadState == 'loaded' and
              fluent_bit_status.status.UnitFileState == 'enabled' }}

    - name: Add fluent-bit repository
      ansible.builtin.copy:
        dest: /etc/yum.repos.d/fluent-bit.repo
        src: fluent-bit.repo
      become: true
      when: not fluent_bit_installed

    - name: Install fluent-bit package
      ansible.builtin.package:
        name: fluent-bit
        state: present
        use: auto
      become: true
      when: not fluent_bit_installed

    - name: Create fluent-bit configuration file with dynamic inputs
      ansible.builtin.template:
        src: fluent-bit.yaml.j2
        dest: /etc/fluent-bit/fluent-bit.yaml
        mode: "0644"
        force: true
      become: true
      notify: Restart fluent-bit

    - name: Add lua script for appending time to records
      ansible.builtin.template:
        src: append_time.lua.j2
        dest: /etc/fluent-bit/append_time.lua
        mode: "0644"
        force: true
      become: true
      notify: Restart fluent-bit

    - name: Add smbcreds file for CIFS mounts
      ansible.builtin.copy:
        content: |
          username={{ smb_username }}
          password={{ smb_password }}
        dest: /root/.smbcreds
        mode: "0600"
        force: true
      become: true

    - name: Ensure cifs-utils is installed
      ansible.builtin.package:
        name: cifs-utils
        state: present
      become: true

    - name: Mount CIFS log shares
      ansible.posix.mount:
        src: "//{{ item.internal_ip }}/LogFiles"
        path: "/mnt/{{ item.name_suffix }}"
        fstype: cifs
        opts: "ro,credentials=/root/.smbcreds,vers=3.1.1,sec=ntlmssp,iocharset=utf8,_netdev,cache=none,nofail,x-systemd.idle-timeout=20s"
        state: mounted
      loop: "{{ instances_with_445_open }}"
      become: true
      register: mount_results
      ignore_errors: true

    - name: Log failed mounts
      ansible.builtin.debug:
        msg: "Failed to mount //{{ item.item.internal_ip }}/LogFiles on /mnt/{{ item.item.name_suffix }}: {{ item.msg | default('unknown error') }}"
      loop: "{{ mount_results.results | selectattr('failed', 'true') | list }}"
      loop_control:
        label: "/mnt/{{ item.item.name_suffix }}"

    # - name: Reboot host to ensure mounts are active and fluent-bit can read logs
    #   ansible.builtin.reboot:
    #     reboot_timeout: 300
    #   become: true

  handlers:
    - name: Restart fluent-bit
      ansible.builtin.systemd:
        name: fluent-bit
        state: restarted
      become: true
