---
- name: Gather data
  hosts: localhost
  gather_facts: false
  vars:
    aws_region: "{{ aws_region | default('') }}"
  tasks:
    - name: Fail if aws_region is not set
      when: aws_region == ''
      ansible.builtin.fail:
        msg: "AWS region is not set"

    - name: Gather EC2 instances info
      amazon.aws.ec2_instance_info:
        region: "{{ aws_region }}"
      register: ec2_info

    - name: Build list of instances with internal IP and parsed Name
      ansible.builtin.set_fact:
        instances_with_445: >-
          {{
            instances_with_445 | default([]) + [
              {
                'id': item.instance_id,
                'name': instance_name,
                'name_suffix': name_suffix,
                'internal_ip': item.network_interfaces[0].private_ip_address
              }
            ]
          }}
      vars:
        instance_name: "{{ item.tags.Name | default('') }}"
        name_suffix: >-
          {{ instance_name | regex_replace('.*\(([^()]*)\)\s*$', '\1') if '(' in instance_name else '' }}
      loop: "{{ ec2_info.instances }}"

    - name: Check if port 445 is open on each instance
      ansible.builtin.command: "nmap -Pn -p 445 {{ item.internal_ip }}"
      register: nmap_result
      loop: "{{ instances_with_445 }}"
      changed_when: false

    - name: Filter instances where port 445 is open
      ansible.builtin.set_fact:
        instances_with_445_open: >-
          {{
            instances_with_445 | zip(nmap_result.results) | selectattr('1.stdout', 'search', '445/tcp open') | map(attribute='0') | list
          }}

    - name: Show instances with port 445 open (confirmed by nmap)
      ansible.builtin.debug:
        var: instances_with_445_open

- name: Configure monitoring host
  hosts: monitoring_hosts
  gather_facts: false
  vars_files:
    - defaults/install_scrapers_defaults.yml
  vars:
    instances_with_445_open: "{{ hostvars['localhost']['instances_with_445_open'] | default([]) }}"
  tasks:
    - name: Build connection details for monitoring hosts
      delegate_to: localhost
      block:
        - name: Include build_connection_details role
          ansible.builtin.include_role:
            name: build_connection_details

    - name: Create fluent-bit configuration file with dynamic inputs
      ansible.builtin.template:
        src: fluent-bit.yml.j2
        dest: /etc/fluent-bit/fluent-bit.yml
        mode: "0644"
        force: true
      become: true
      notify: Restart fluent-bit

    - name: Add lua script for appending time to records
      ansible.builtin.template:
        src: append_time.lua.j2
        dest: /etc/fluent-bit/append_time.lua
        mode: "0644"
        force: true
      become: true
      notify: Restart fluent-bit

    - name: Mount CIFS log shares
      ansible.posix.mount:
        src: "//{{ item.internal_ip }}/LogFiles"
        path: "/mnt/{{ item.name_suffix }}"
        fstype: cifs
        opts: "credentials=/root/.smbcreds,vers=3.1.1,sec=ntlmssp,iocharset=utf8,_netdev,cache=none,nofail,x-systemd.idle-timeout=20s"
        state: mounted
      loop: "{{ instances_with_445_open }}"
      become: true

    - name: Reboot host to ensure mounts are active and fluent-bit can read logs
      ansible.builtin.reboot:
        reboot_timeout: 300
      become: true

  handlers:
    - name: Restart fluent-bit
      ansible.builtin.systemd:
        name: fluent-bit
        state: restarted
      become: true
